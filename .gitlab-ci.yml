image: registry.tccenter.ru/public/golang:1.17.7-buster

stages:
  - test
  - build

format:
  stage: test
  script:
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)
    - go test -race $(go list ./... | grep -v /vendor/)

compile:
  stage: build
  script:
    - mkdir -p binaries
    - |
      platforms=("windows/amd64" "windows/386" "darwin/amd64")

      for platform in "${platforms[@]}"
      do
      	platform_split=(${platform//\// })
      	GOOS=${platform_split[0]}
      	GOARCH=${platform_split[1]}
      	output_name=$package_name'-'$GOOS'-'$GOARCH-$CI_COMMIT_TAG
      	if [ $GOOS = "windows" ]; then
      		output_name+='.exe'
      	fi	

      	env GOOS=$GOOS GOARCH=$GOARCH go build -o binaries/$output_name
      	if [ $? -ne 0 ]; then
         		echo 'An error has occurred! Aborting the script execution...'
      		exit 1
      	fi
      done
  artifacts:
    paths:
      - binaries
  only:
    - tags
